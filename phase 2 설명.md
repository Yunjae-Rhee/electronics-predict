# 공급망 최적화 모델 요약 보고서

## 1. 목적식
목표:  
USD 기준 총비용 + 환경부담금 최소화  

총비용 구성:
- 생산비용
- 운송비용
- 재고 보관비용
- 부족 패널티
- 설비 건설비
- 운송 모드 변경 수수료

---

## 2. 제약식 요약

### 2-1. 서비스 수준
- Fill-Rate 95% 이상 유지

### 2-2. 시설
- 공장 최대 5곳, 창고 최대 20곳
- 동일 도시에 공장·창고 각각 1곳만 설치 가능
- 공장에는 재고 불가
- 공장: 착공 다음 월요일 00시부터 가동, 폐쇄 불가
- 창고: 착공 즉시 완공
- 초기 상태: 모든 창고-SKU 재고 2,000 unit

### 2-3. 생산
- 주별 정규·초과 근무 한도 초과 불가
- SKU별 노동시간 × 생산량 ≤ 주당 최대 근로시간
- 1일 8시간 초과 생산분 → 초과근무 임금 적용
- 기계 고장 기간 중 해당 공장 모든 작업 정지

### 2-4. 재고·유효기간
- 해당 도시에 창고가 있으면 운송비용 없이 수요 소화
- 유효기간(life_days) 경과 재고는 반드시 폐기

### 2-5. 운송
- 허용 경로: 공장→창고, 창고→도시 (창고→창고 불가)
- 동일 국가: 트럭만 허용
- 국가 간: 배 또는 비행기
- 컨테이너 용량: 4,000 unit (부분 적재 허용, 비용 1컨테이너 기준)
- 1회 운송에 복수 모드 혼합 불가
- 국경 통과: 4,000 USD (DEU↔FRA 면제)
- 악천후 시 운송비 ×3 (출발 당일 기준)
- 유가 전주 대비 +5% 이상 상승 시 해당 주 운송비 ×2
- "구간-요일-모드" 4주 고정, 변경 시 직전 4주 운송비의 5% 수수료
- 동일 구간·요일에 모드 분할 운송 금지

### 2-6. 환경부담금
- 생산 CO₂ = carbon_factor_prod × 생산량
- 운송 CO₂ = 거리 × 모드별 CO₂계수 × 컨테이너 수
- 합산 후 200 USD/ton 부과  
  (올림 계산, 1ton 미만도 1ton 적용)

---

## 3. 구현 방식

### Chunked Rolling Horizon MILP
1. 기간 분할 (31일 단위)  
   - 전체 기간을 최대 31일(약 1개월) 길이의 청크(chunk)로 나눔  
   - 각 청크별로 날짜·SKU·도시별 생산·운송·재고 의사결정 수행  
   - 청크 간 연속성 유지를 위해 다음 데이터 전달:
     1. 이전 청크 종료 시점 재고 (창고-SKU별)
     2. 이전 청크에서 출발했으나 도착하지 않은 운송 물량 (리드타임 반영)

2. 순차 최적화
   - 각 청크는 독립적으로 풀지만, 초기 상태를 이어받아 전 기간 연속성 확보
   - Fill-Rate, 생산·운송·재고 제약 유지
   - 계산 복잡도 O(N×기간) → O(N×청크)로 축소

---

## 4. 문제 축소·간소화 기법

### 4-1. Arc Pruning (네트워크 축소)

필요성  
- 공장 후보지 × 창고 후보지 + 창고 후보지 × 도시 수  
- 각 날짜 × 운송 모드 × SKU 조합까지 고려 시 변수(Y, Q) 기하급수적 증가  
- 예: 80개 도시(공장·창고 후보) × 40개 도시(수요지) × 3모드 × 2년치 날짜 = 수백만 Arc  
→ 변수·제약 수 과도 → 연산 불가능

핵심 아이디어  
- 선택 가능성이 낮은 비효율 Arc를 사전 제거  
- 본 구현은 On-the-fly Filtering 방식 적용:
  - 모든 Arc를 미리 만들고 제거하는 대신, 모델 빌드 시 조건을 만족하지 않는 Arc는 생성하지 않음

필터 조건
1. 리드타임 기반  
   - Arc 출발일 + 리드타임이 청크 내 도착일 범위에 없으면 제외
2. 유통기한 기반  
   - 도착 시점이 SKU의 유효 기간 초과 시 제외
3. 네트워크 연결성 기반  
   - (i,k) in IK 또는 (k,j) in KJ 조건만 허용  
   - 창고→창고, 금지 모드 등은 생성 안 함

---

### 4-2. 제약 완화
- Fill-Rate → 주간 합 기준 + Slack (패널티 부과)
- 일부 이진 제약 (예: 모드 변경) → Relaxation 처리